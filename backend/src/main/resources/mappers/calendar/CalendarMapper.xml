<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.spec.plun.calendar.dao.CalendarDAO">

  <insert id="insertParticipants" parameterType="map">
	  INSERT INTO tb_calendar_detail_participant (cal_detail_no, user_no)
	  VALUES
	  <foreach collection="userNos" item="userNo" separator=",">
	    (#{calDetailNo}, #{userNo})
	  </foreach>
  </insert>
	
  <select id="getParticipantsByCalDetailNo" resultType="int">
	SELECT user_no FROM tb_calendar_detail_participant WHERE cal_detail_no = #{calDetailNo}
  </select>
  
  <insert id="insertParticipant">
	INSERT INTO tb_calendar_detail_participant (cal_detail_no, user_no)
	VALUES (#{calDetailNo}, #{userNo})
  </insert>

  <select id="getCalNoByTeamAndUser" resultType="Integer">
	SELECT cal_no
	FROM TB_CALENDAR
	WHERE team_no = #{teamNo}
	  AND user_no = #{userNo}
  </select>
  
  <insert id="insertCalendar" parameterType="com.spec.plun.calendar.entity.Calendar" useGeneratedKeys="true" keyProperty="calNo">
	INSERT INTO TB_CALENDAR (team_no, user_no)
	VALUES (#{teamNo}, #{userNo})
  </insert>
  
  <!-- ÏùºÏ†ï Í≥µÏú† Î©§Î≤Ñ Îì±Î°ù -->
  <select id="getCalNoByUserNo" resultType="int" parameterType="Integer">
    SELECT cal_no FROM TB_CALENDAR WHERE user_no = #{userNo}
  </select>
  
  <!-- ÏùºÏ†ï Ï°∞Ìöå -->
  <select id="getEventsBetween" resultType="com.spec.plun.calendar.entity.CalendarDetail" parameterType="map">
	    (
      SELECT cd.*
      FROM TB_CALENDAR c
      JOIN TB_CALENDARDETAIL cd ON c.cal_no = cd.cal_no
      WHERE c.user_no = #{userNo}
        AND cd.start_date &lt;= #{end}
        AND cd.end_date &gt;= #{start}
        AND cd.delete_yn = 'N'
    )
    UNION
    (
      SELECT cd.*
      FROM tb_calendar_detail_participant p
      JOIN TB_CALENDARDETAIL cd ON p.cal_detail_no = cd.cal_detail_no
      WHERE p.user_no = #{userNo}
        AND cd.start_date &lt;= #{end}
        AND cd.end_date &gt;= #{start}
        AND cd.delete_yn = 'N'
    )
<!-- 	SELECT cd.*
	FROM TB_CALENDAR c
	JOIN TB_CALENDARDETAIL cd ON c.cal_no = cd.cal_no
	WHERE c.user_no = #{userNo}
	  AND cd.start_date &lt;= #{end}
	  AND cd.end_date &gt;= #{start}
	  AND cd.delete_yn = 'N' -->
	</select>
	
  <select id="getEventsBetweenShared" 
        resultType="com.spec.plun.calendar.entity.CalendarDetail" 
        parameterType="map">
	SELECT cd.*
	FROM TB_CALENDAR c
	JOIN TB_CALENDARDETAIL cd ON c.cal_no = cd.cal_no
	WHERE c.user_no = #{userNo}                 -- üìå ÎÇòÏóêÍ≤å Í≥µÏú†Îêú ÏùºÏ†ïÎì§
	  AND cd.start_date &lt;= #{end}
	  AND cd.end_date &gt;= #{start}
	  AND cd.delete_yn = 'N'
  </select>
  <!-- ÏùºÏ†ï Îì±Î°ù -->
  <insert id="insertEvent" parameterType="com.spec.plun.calendar.entity.CalendarDetail" useGeneratedKeys="true" keyProperty="calDetailNo">
    INSERT INTO TB_CALENDARDETAIL (
        cal_no, title, contents, start_date, start_time,
        end_date, end_time, delete_yn, create_date, reg_user_no
    )
    VALUES (
        #{calNo}, #{title}, #{contents}, #{startDate}, #{startTime},
        #{endDate}, #{endTime}, 'N', NOW(), #{regUserNo}
    )
  </insert>
  <!-- ÏùºÏ†ï ÏàòÏ†ï -->
  <update id="updateEvent" parameterType="com.spec.plun.calendar.entity.CalendarDetail">
	UPDATE tb_calendardetail
	SET
	  title = #{title},
	  contents = #{contents},
	  start_date = #{startDate},
	  start_time = #{startTime},
	  end_date = #{endDate},
	  end_time = #{endTime},
	  update_dt = NOW(),
	  update_user_no = #{updateUserNo}
	WHERE cal_detail_no = #{calDetailNo}
  </update>
  <!-- ÏùºÏ†ï ÏÇ≠Ï†ú -->
  <update id="deleteEvent">
	UPDATE tb_calendardetail
	SET delete_yn = 'Y', update_dt = NOW()
	WHERE cal_detail_no = #{calDetailNo}
  </update>
  <!-- Ï∞∏Í∞ÄÏûê Ï†ïÎ≥¥ ÏÇ≠Ï†ú -->
  <delete id="deleteParticipantsByCalDetailNo">
	DELETE FROM tb_calendar_detail_participant
	WHERE cal_detail_no = #{calDetailNo}
  </delete>

</mapper>
  